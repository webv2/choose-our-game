<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Picks — Group-ready Board</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa6b2; --accent:#4f46e5;
    --glass: rgba(255,255,255,0.03);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%; margin:0; background:
    linear-gradient(180deg, #071020 0%, #071527 50%, #041018 100%); color:#e6eef6;}
  .wrap{max-width:1200px; margin:28px auto; padding:18px;}
  header{display:flex;align-items:center;gap:16px;margin-bottom:18px;}
  h1{margin:0;font-size:20px;letter-spacing:-0.2px; margin-left: 16px;}
  .back-btn {
    background: rgba(255,255,255,0.05); color: var(--muted); text-decoration: none;
    border: 1px solid rgba(255,255,255,0.08); padding: 8px 12px; border-radius: 10px;
    cursor: pointer; font-weight: 600; transition: background-color 0.2s;
  }
  .back-btn:hover { background: rgba(255,255,255,0.1); }
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  button, .small-btn {background:var(--accent); color:white; border:0; padding:8px 12px; border-radius:10px; cursor:pointer;}
  .small-btn{padding:6px 10px;font-size:13px}
  .board{display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:14px;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015)); border-radius:12px; overflow:hidden; box-shadow: 0 6px 18px rgba(2,6,23,0.7); border:1px solid rgba(255,255,255,0.02);}
  .cover{height:120px; background:#071023; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:600; font-size:18px;}
  .meta{padding:10px 12px;}
  .title-row{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .title{font-weight:600; font-size:15px; margin-right:8px}
  .votes{background:var(--glass); padding:6px 8px; border-radius:999px; font-size:13px; color:var(--muted)}
  .players{margin-top:10px; font-size:13px; color:var(--muted); min-height:34px;}
  .player{display:inline-flex; background:rgba(255,255,255,0.03); padding:6px 8px; border-radius:999px; margin:4px 6px 0 0; align-items:center; gap:8px;}
  .player button{background:transparent;border:0;color:#ff7b7b;cursor:pointer;padding:0 4px;font-weight:700}
  .actions{display:flex; gap:8px; margin-top:12px}
  .join{flex:1; background:transparent; border:1px dashed rgba(255,255,255,0.06); padding:8px;border-radius:10px;color:var(--muted); cursor:pointer}
  .join-form { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }
  .join-form-buttons { display: flex; gap: 6px; }
  .join-form-buttons .small-btn { flex-grow: 1; }
  input[type="text"]{background:transparent;border:1px solid rgba(255,255,255,0.04); padding:8px;border-radius:8px;color:inherit; outline:none; width:100%; box-sizing: border-box;}
  .toolbar{display:flex; gap:8px; margin-bottom:12px; align-items:center}
  .search-row{display:flex; gap:8px; align-items:center}
  .pill{background:rgba(255,255,255,0.02); padding:6px 10px;border-radius:999px; font-size:13px; color:var(--muted)}
  .img-fallback{width:100%;height:100%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:20px; letter-spacing:0.6px}
  footer{margin-top:18px; font-size:13px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="index.html" class="back-btn">← Back to Main</a>
    <h1>Group-ready Game Board</h1>
    <div class="controls">
      <div class="pill" id="stats">Loading...</div>
    </div>
  </header>

  <div class="toolbar">
    <div class="search-row">
      <input type="text" id="filterInput" placeholder="Filter games by name..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:320px" />
      <button class="small-btn" id="clearFilter">Clear</button>
    </div>
  </div>

  <div class="board" id="board"></div>

  <footer>
    <div>Usage: Click <strong>Join</strong> on a game card and type your name. Changes are saved to the database and are visible to everyone in real-time.</div>
  </footer>
</div>

<script>
/*
  Game Board - Supabase Real-time Version (Corrected)
*/

// --- CONFIGURATION ---
const SUPABASE_URL = 'https://lgtajqxzcgutovcqwepe.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxndGFqcXh6Y2d1dG92Y3F3ZXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDg3NjIsImV4cCI6MjA3NTc4NDc2Mn0.QKnnpZ4fHrgpSeCeyJ2qVOJUqafd3jxRF4j5uMenMbg';
const API_KEY_STORAGE = 'chooseOurGameApiKey';

// --- INITIALIZATION ---
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let gameData = [];

const initialGames = [
  {game_name:"Valheim", votes:5}, {game_name:"No Man's Sky", votes:4}, {game_name:"Grand Theft Auto V", votes:4}, {game_name:"Satisfactory", votes:3},
  {game_name:"7 Days to Die", votes:3}, {game_name:"Tom Clancy's The Division 2", votes:3}, {game_name:"Cuphead", votes:3}, {game_name:"Among Us", votes:3},
  {game_name:"Mortal Kombat 11", votes:3}, {game_name:"Phasmophobia", votes:3}, {game_name:"Portal 2", votes:3}, {game_name:"Dying Light: The Following - Enhanced Edition", votes:2},
  {game_name:"Path of Exile", votes:2}, {game_name:"Tom Clancy's Ghost Recon Wildlands", votes:2}, {game_name:"Fallout 76", votes:2}, {game_name:"Rocket League", votes:2},
  {game_name:"Mortal Kombat X", votes:2}, {game_name:"Need for Speed", votes:2}, {game_name:"Remnant: From the Ashes", votes:2}, {game_name:"Worms Armageddon", votes:2},
  {game_name:"Dead Island Definitive Edition", votes:2}, {game_name:"Quake III Arena", votes:2}, {game_name:"Diablo III", votes:2}, {game_name:"Dead Island: Riptide Definitive Edition", votes:2},
  {game_name:"Rise of Nations: Extended Edition", votes:2}, {game_name:"Counter-Strike: Global Offensive", votes:2}, {game_name:"PAYDAY 2", votes:2},
  {game_name:"Tomb Raider (2013)", votes:2}, {game_name:"Red Dead Redemption 2", votes:2}, {game_name:"Batman: Arkham Knight", votes:2},
  {game_name:"Borderlands 2", votes:2}, {game_name:"Terraria", votes:2}
];

// --- CORE FUNCTIONS ---

function updateStats(){
  const games = gameData.length;
  const totalPlayers = gameData.reduce((sum, game) => sum + (game.players ? game.players.length : 0), 0);
  document.getElementById('stats').textContent = `Games: ${games} — Total players: ${totalPlayers}`;
}

function renderBoard(filter = ''){
  const board = document.getElementById('board');
  const currentFilter = filter.toLowerCase();
  board.innerHTML = '';
  const list = gameData.filter(g => g.game_name.toLowerCase().includes(currentFilter));
  
  list.forEach(game => {
    const card = document.createElement('div');
    card.className = 'card';
    
    const cover = document.createElement('div');
    cover.className = 'cover';
    if(game.img){
      const img = document.createElement('img');
      img.src = game.img; img.alt = game.game_name;
      img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      img.onerror = ()=> { cover.innerHTML = fallbackCoverHTML(game); };
      cover.appendChild(img);
    } else {
      cover.innerHTML = fallbackCoverHTML(game);
    }
    
    const meta = document.createElement('div');
    meta.className = 'meta';
    
    const titleRow = document.createElement('div');
    titleRow.className = 'title-row';
    const title = document.createElement('div');
    title.className = 'title'; title.textContent = game.game_name;
    const votes = document.createElement('div');
    votes.className = 'votes'; votes.textContent = `${game.votes} votes`;
    titleRow.appendChild(title); titleRow.appendChild(votes);
    
    const playersDiv = document.createElement('div');
    playersDiv.className = 'players';
    if(game.players && game.players.length){
      game.players.forEach((player, playerIndex)=>{
        const pill = document.createElement('span');
        pill.className='player';
        pill.innerHTML = `<span>${escapeHtml(player)}</span><button title="remove" data-game-name="${game.game_name}" data-player-idx="${playerIndex}">×</button>`;
        playersDiv.appendChild(pill);
      });
    } else {
      playersDiv.innerHTML = `<div style="color:var(--muted)">No players yet</div>`;
    }
    
    const actions = document.createElement('div');
    actions.className = 'actions';
    const joinBtn = document.createElement('button');
    joinBtn.className = 'join';
    joinBtn.textContent = 'Join';
    joinBtn.addEventListener('click', (e) => openJoinInline(game.game_name, e.currentTarget));
    actions.appendChild(joinBtn);

    meta.appendChild(titleRow);
    meta.appendChild(playersDiv);
    meta.appendChild(actions);

    card.appendChild(cover);
    card.appendChild(meta);
    board.appendChild(card);
  });
  updateStats();
}

async function addPlayer(gameName, playerName) {
    const game = gameData.find(g => g.game_name === gameName);
    if (!game) return;

    // --- Optimistic UI Update ---
    game.players.push(playerName);
    renderBoard(document.getElementById('filterInput').value || '');

    // --- Sync with Database ---
    const { error } = await supabaseClient
        .from('game_groups')
        .update({ players: game.players })
        .eq('game_name', gameName);
    
    if (error) {
        console.error("Error adding player:", error);
        // Optional: Revert UI change on error
        game.players.pop();
        renderBoard(document.getElementById('filterInput').value || '');
        alert("Failed to save your name. Please try again.");
    }
}

async function removePlayer(gameName, playerIndex) {
    const game = gameData.find(g => g.game_name === gameName);
    if (!game) return;
    const removedPlayer = game.players[playerIndex];

    // --- Optimistic UI Update ---
    game.players.splice(playerIndex, 1);
    renderBoard(document.getElementById('filterInput').value || '');

    // --- Sync with Database ---
    const { error } = await supabaseClient
        .from('game_groups')
        .update({ players: game.players })
        .eq('game_name', gameName);

    if (error) {
        console.error("Error removing player:", error);
        // Optional: Revert UI change on error
        game.players.splice(playerIndex, 0, removedPlayer);
        renderBoard(document.getElementById('filterInput').value || '');
        alert("Failed to remove the player. Please try again.");
    }
}

// --- UI AND HELPER FUNCTIONS ---

function openJoinInline(gameName, joinBtn){
  if (document.querySelector('.join-form')) {
    document.querySelector('.join-form button[name="cancel"]').click();
  }

  const actionsContainer = joinBtn.parentElement;
  joinBtn.style.display = 'none';

  const formWrapper = document.createElement('div');
  formWrapper.className = 'join-form';

  const buttonRow = document.createElement('div');
  buttonRow.className = 'join-form-buttons';
  
  const addBtn = document.createElement('button');
  addBtn.className = 'small-btn'; addBtn.textContent = 'Add';
  const cancelBtn = document.createElement('button');
  cancelBtn.className = 'small-btn'; cancelBtn.textContent = 'Cancel'; cancelBtn.name = 'cancel';
  
  buttonRow.appendChild(addBtn); buttonRow.appendChild(cancelBtn);

  const input = document.createElement('input');
  input.type = 'text'; input.placeholder = 'Type your name and press Enter';

  formWrapper.appendChild(buttonRow);
  formWrapper.appendChild(input);
  actionsContainer.appendChild(formWrapper);
  input.focus();

  const close = () => { formWrapper.remove(); joinBtn.style.display = 'block'; };

  addBtn.addEventListener('click', async () => {
    const name = input.value.trim();
    if(!name) return;
    await addPlayer(gameName, name);
    close();
  });

  cancelBtn.addEventListener('click', close);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') addBtn.click();
    if (e.key === 'Escape') close();
  });
}

function fallbackCoverHTML(game){
  const initials = game.game_name.split(' ').slice(0,2).map(s=>s[0]).join('').substring(0,2).toUpperCase();
  const colorSeed = hashCode(game.game_name);
  const hue = Math.abs(colorSeed) % 360;
  return `<div class="img-fallback" style="background:linear-gradient(135deg,hsl(${hue} 60% 30%), hsl(${(hue+60)%360} 60% 40%));">${initials}</div>`;
}

function hashCode(str){
  let h=0;
  for(let i=0;i<str.length;i++) h = ((h<<5)-h)+str.charCodeAt(i)|0;
  return h;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// --- AUTOMATIC IMAGE FETCHER ---
async function fetchAllImagesConcurrently(key) {
    const gamesToFetch = gameData.filter(g => !g.img);
    if (gamesToFetch.length === 0) return;

    const updates = await Promise.all(gamesToFetch.map(async (game) => {
        try {
            const q = encodeURIComponent(game.game_name);
            const url = `https://api.rawg.io/api/games?search=${q}&key=${key}`;
            const resp = await fetch(url);
            const json = await resp.json();
            const imageUrl = json.results?.[0]?.background_image || null;
            if (imageUrl) {
                return { ...game, img: imageUrl };
            }
        } catch (err) { console.warn(err); }
        return null;
    }));

    const validUpdates = updates.filter(Boolean);
    if (validUpdates.length > 0) {
        const { error } = await supabaseClient.from('game_groups').upsert(validUpdates);
        if (error) console.error("Error saving fetched images:", error);
    }
}

// --- INITIALIZATION AND REAL-TIME SUBSCRIPTION ---

async function initializeBoard() {
    const { data, error } = await supabaseClient.from('game_groups').select('*');
    
    if (error) { console.error('Error fetching data:', error); return; }

    if (data.length === 0) {
        console.log('Database is empty, seeding with initial games...');
        const { error: insertError } = await supabaseClient.from('game_groups').insert(initialGames);
        if (insertError) {
            console.error('Error seeding database:', insertError);
        } else {
            const { data: newData } = await supabaseClient.from('game_groups').select('*');
            gameData = newData || [];
        }
    } else {
        gameData = data;
    }

    renderBoard();

    supabaseClient.channel('game_groups_changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'game_groups' }, payload => {
            const record = payload.new;
            const key = record.game_name || payload.old.game_name;
            const index = gameData.findIndex(g => g.game_name === key);

            if (payload.eventType === 'DELETE') {
                 if (index !== -1) gameData.splice(index, 1);
            } else {
                if (index !== -1) { gameData[index] = record; } else { gameData.push(record); }
            }
            renderBoard(document.getElementById('filterInput').value || '');
        })
        .subscribe();

    const apiKey = localStorage.getItem(API_KEY_STORAGE);
    if (apiKey) {
        fetchAllImagesConcurrently(apiKey);
    }
}

// --- EVENT LISTENERS ---
document.getElementById('filterInput').addEventListener('input', (e)=> renderBoard(e.target.value));
document.getElementById('clearFilter').addEventListener('click', ()=> {document.getElementById('filterInput').value=''; renderBoard('')});

document.getElementById('board').addEventListener('click', e => {
    if (e.target.matches('.player button')) {
        const btn = e.target;
        const gameName = btn.dataset.gameName;
        const playerIndex = parseInt(btn.dataset.playerIdx, 10);
        removePlayer(gameName, playerIndex);
    }
});

// --- START THE APP ---
initializeBoard();
</script>
</body>
</html>
